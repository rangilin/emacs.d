<p>Some Rubyists, when faced with the task of matching against the
beginning or the end of a string, are prone to using <code>^</code> and <code>$</code> in
their regular expressions. Most of the time the code will seem to work properly,
but&hellip; these anchors don&rsquo;t actually match a string&rsquo;s beginning and
end &ndash; they match a <strong>line</strong>&rsquo;s beginning and end. Consider the
following example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;username&#39;</span>
</span><span class='line'><span class="n">string</span><span class="o">[</span><span class="sr">/^username$/</span><span class="o">]</span>   <span class="c1"># matches (as expected)</span>
</span><span class='line'><span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;some injection</span><span class="se">\n</span><span class="s2">username&quot;</span>
</span><span class='line'><span class="n">string</span><span class="o">[</span><span class="sr">/^username$/</span><span class="o">]</span>   <span class="c1"># matches again(WAT???)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The anchors for beginning and end of a string are actually <code>\A</code> and
<code>\z</code>(there&rsquo;s also a similar <code>\Z</code> anchor, but it&rsquo;s rarely used in
practice):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;some injection</span><span class="se">\n</span><span class="s2">username&quot;</span>
</span><span class='line'><span class="n">string</span><span class="o">[</span><span class="sr">/\Ausername\z/</span><span class="o">]</span> <span class="c1"># don&#39;t match</span>
</span></code></pre></td></tr></table></div></figure>


<p>In an actual application the line <code>string[/^username$/]</code> is a recipe for
disaster. That&rsquo;s why Rails 4 started raising exceptions when <code>^</code> and
<code>$</code> are used in <code>validates :something, format: { with: /.../ }</code>.</p>

<p>By the way, this isn&rsquo;t something specific to Ruby at all &ndash;  <code>\A</code> and <code>\z</code> are not the same
thing as <code>^</code> and <code>$</code> in most programming languages that have Perl-style regular expressions.</p>

<p>There&rsquo;s something peculiar in Ruby, though &ndash; it automatically uses
<strong>multiline mode</strong> (which enables the aforementioned behaviour of
having <code>^</code> and <code>$</code> match per line) for regular expressions. Other
languages support it as well, but usually you need to enable it
yourself, since it&rsquo;s not consider a particularly intuitive
default. For example &ndash; by default Perl, Java and C# treat <code>^</code> and <code>$</code> as
beginning/end of string until you <strong>explicitly</strong> enable <strong>multiline match mode</strong>
(<code>/m</code>). In Ruby <code>/m</code> simply allows <code>.</code> to match newlines.</p>

<p>I guess people, who&rsquo;ve recently switched to Ruby from another
language, would be most susceptible to writing potentially dangerous
code like this.</p>

<p>That&rsquo;s all for today folks. I hope you&rsquo;ll find this article useful.
As usual I&rsquo;m looking forward to hearing your thoughts here and on
<a href="http://twitter.com/bbatsov">Twitter</a>!</p>
