<p>There’s a neat trick for dynamically constructing heterogeneous
classes using a single factory function in CoffeeScript.(This is
probably a common pattern among Coffeescript cognoscenti, but I hadn’t
bumped into it, so I thought it was worth jotting down.)</p>

<p>I’m in the middle of writing a CoffeeScript application which handles
a variety of related but different user interface widgets. I’d
normally treat each as an independent class, and use mixins for the
common functionality. But in this particular app, it turns out to be
incredibly convenient to have a single factory method that takes a DOM
element and uses a data-type attribute to generate an object of the
correct class. That is, given</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;widget&quot;</span> <span class="na">data-type=</span><span class="s">&quot;Wibble&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    …
</span><span class='line'><span class="nt">&lt;/article&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I’d want an object of class <code>Wibble</code>, and given</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;widget&quot;</span> <span class="na">data-type=</span><span class="s">&quot;Wobble&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    …
</span><span class='line'><span class="nt">&lt;/article&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I’d want a <code>Wobble</code> object.</p>

<p>The initialization code to create these objects will look something like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.widget&quot;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Widget</span><span class="p">.</span><span class="nx">for_element</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">))</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here’s what I came up with for the <code>for_element</code> factory method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Widget</span>
</span><span class='line'>    <span class="vi">@for_element: </span><span class="nf">(el) -&gt;</span>
</span><span class='line'>        <span class="nv">type = </span><span class="nx">el</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">new</span> <span class="nx">@</span><span class="p">[</span><span class="nx">type</span><span class="p">](</span><span class="nx">el</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">constructor: </span><span class="nf">(@el) -&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nx">Widget</span><span class="p">.</span><span class="nx">Wibble</span> <span class="k">extends</span> <span class="nx">Widget</span>
</span><span class='line'>    <span class="nv">constructor: </span><span class="nf">(el) -&gt;</span>
</span><span class='line'>        <span class="c1"># subclass-specific stuff</span>
</span><span class='line'>        <span class="nx">superclass</span> <span class="nx">Widget</span><span class="p">.</span><span class="nx">Wobble</span> <span class="k">extends</span> <span class="nx">Widget</span>
</span><span class='line'>    <span class="nv">constructor: </span><span class="nf">(el) -&gt;</span>
</span><span class='line'>        <span class="c1"># subclass-specific stuff</span>
</span><span class='line'>        <span class="k">super</span>
</span></code></pre></td></tr></table></div></figure>


<p>The fun part of this is that by namespacing the individual widget
subclasses in the parent <code>Widget</code> class, I can use <code>new @[type](el)</code>
to look up the subclass in the factory, and then instantiate the
object.</p>
